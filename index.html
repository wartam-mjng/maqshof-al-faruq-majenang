import React, { useState, useEffect } from 'react';
import { 
  ShoppingBag, LayoutDashboard, Package, ShoppingCart, 
  LogOut, Plus, Send, Edit3, Store, ShoppingBasket,
  ChevronRight, Search, User
} from 'lucide-react';

// URL Web App dari Google Apps Script Anda (DIPERBARUI)
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwrLBxuyWeQ1OcebLeHzHKYlAaZYy3jaGOOxB1A_BxVnMVQzGhrSBTFTkJo-iFn0oXA/exec";
const ADMIN_WA = "6285154989545";

export default function App() {
  const [screen, setScreen] = useState('auth');
  const [authMode, setAuthMode] = useState('login');
  const [currentUser, setCurrentUser] = useState(null);
  const [page, setPage] = useState('dashboard');
  const [inventory, setInventory] = useState([]);
  const [cart, setCart] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [loadingText, setLoadingText] = useState('Memproses...');
  const [modalOpen, setModalOpen] = useState(false);
  const [formData, setFormData] = useState({ id: '', nama: '', kategori: '', harga: '', stok: '' });

  // Load data awal
  useEffect(() => {
    if (currentUser) {
      fetchData();
    }
  }, [currentUser]);

  const fetchData = async () => {
    setIsLoading(true);
    setLoadingText('Mengambil data...');
    try {
      const res = await fetch(WEB_APP_URL);
      if (!res.ok) throw new Error("Network response was not ok");
      const data = await res.json();
      setInventory(data);
    } catch (e) {
      console.error("Gagal mengambil data, pastikan URL GAS benar.", e);
    }
    setIsLoading(false);
  };

  const handleLogin = async (e) => {
    e.preventDefault();
    const u = e.target.username.value;
    const p = e.target.password.value;
    setIsLoading(true);
    setLoadingText('Memverifikasi...');
    try {
      const res = await fetch(`${WEB_APP_URL}?action=login&u=${u}&p=${p}`);
      const result = await res.json();
      if (result.status === "success") {
        setCurrentUser(result.user);
        setScreen('main');
      } else {
        alert("Username atau password salah!");
      }
    } catch (err) {
      alert("Gagal terhubung ke database. Pastikan koneksi internet stabil.");
    }
    setIsLoading(false);
  };

  const handleRegister = async (e) => {
    e.preventDefault();
    const data = {
      action: 'register',
      nama: e.target.reg_name.value,
      username: e.target.reg_username.value,
      password: e.target.reg_password.value
    };
    setIsLoading(true);
    setLoadingText('Mendaftarkan...');
    try {
      await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
      alert("Berhasil daftar! Silakan login.");
      setAuthMode('login');
    } catch (err) {
      alert("Terjadi kesalahan pendaftaran.");
    }
    setIsLoading(false);
  };

  const saveBarang = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    const data = { action: 'saveBarang', ...formData };
    try {
      await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
      setModalOpen(false);
      setTimeout(fetchData, 1000);
    } catch (e) {
      alert("Gagal menyimpan.");
    }
    setIsLoading(false);
  };

  const addToCart = (item) => {
    const inCart = cart.find(c => c.id === item.id);
    if (item.stok <= (inCart ? inCart.qty : 0)) return alert("Stok habis!");
    if (inCart) {
      setCart(cart.map(c => c.id === item.id ? { ...c, qty: c.qty + 1 } : c));
    } else {
      setCart([...cart, { ...item, qty: 1 }]);
    }
  };

  const processOrder = async () => {
    if (!cart.length) return;
    setIsLoading(true);
    setLoadingText('Menyimpan pesanan...');
    const totalHarga = cart.reduce((a, b) => a + (b.harga * b.qty), 0);
    const detailMsg = cart.map(i => `- ${i.nama} [${i.kategori}] (x${i.qty})`).join('%0A');
    const waMsg = `Halo Admin, pesanan dari *${currentUser.nama}*:%0A${detailMsg}%0A%0A*Total: Rp ${totalHarga.toLocaleString()}*`;
    
    try {
      await fetch(WEB_APP_URL, { 
        method: 'POST', 
        mode: 'no-cors', 
        body: JSON.stringify({ action: 'jual', user: currentUser.nama, items: cart }) 
      });
      window.open(`https://wa.me/${ADMIN_WA}?text=${waMsg}`, '_blank');
      setCart([]);
      setTimeout(fetchData, 1000);
      setPage('dashboard');
    } catch (e) {
      alert("Gagal memproses pesanan.");
    }
    setIsLoading(false);
  };

  if (screen === 'auth') {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        {isLoading && <LoadingOverlay text={loadingText} />}
        <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md">
          <div className="text-center mb-8">
            <div className="bg-orange-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4">
              <ShoppingBag className="text-orange-600 w-8 h-8" />
            </div>
            <h1 className="text-2xl font-bold">{authMode === 'login' ? 'Maqshof Digital' : 'Daftar Anggota'}</h1>
            <p className="text-slate-500 text-sm">Sistem Koperasi Terintegrasi</p>
          </div>

          {authMode === 'login' ? (
            <form onSubmit={handleLogin} className="space-y-4">
              <input type="text" name="username" placeholder="Username" required className="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-orange-500" />
              <input type="password" name="password" placeholder="Password" required className="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-orange-500" />
              <button className="w-full bg-orange-600 text-white py-4 rounded-2xl font-bold hover:bg-orange-700 transition">Masuk</button>
              <p className="text-center text-sm">Belum punya akun? <button type="button" onClick={() => setAuthMode('register')} className="text-orange-600 font-bold">Daftar</button></p>
            </form>
          ) : (
            <form onSubmit={handleRegister} className="space-y-4">
              <input type="text" name="reg_name" placeholder="Nama Lengkap" required className="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-orange-500" />
              <input type="text" name="reg_username" placeholder="Username Baru" required className="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-orange-500" />
              <input type="password" name="reg_password" placeholder="Password" required className="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-orange-500" />
              <button className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-slate-800 transition">Buat Akun</button>
              <button type="button" onClick={() => setAuthMode('login')} className="w-full text-slate-400 font-bold py-2">Kembali ke Login</button>
            </form>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="flex h-screen bg-slate-50">
      {isLoading && <LoadingOverlay text={loadingText} />}
      
      {/* Sidebar */}
      <aside className="w-64 bg-slate-900 text-white hidden md:flex flex-col">
        <div className="p-6 border-b border-slate-800 flex items-center gap-3">
          <ShoppingBag className="text-orange-500" />
          <span className="font-bold text-lg">Maqshof Al Faruq</span>
        </div>
        <nav className="flex-1 p-4 space-y-2">
          <NavItem active={page === 'dashboard'} onClick={() => setPage('dashboard')} icon={<LayoutDashboard size={20}/>} label="Dashboard" />
          {currentUser.role === 'admin' && (
            <NavItem active={page === 'barang'} onClick={() => setPage('barang')} icon={<Package size={20}/>} label="Kelola Stok" />
          )}
          <NavItem active={page === 'penjualan'} onClick={() => setPage('penjualan')} icon={<ShoppingCart size={20}/>} label="Pesan Barang" />
        </nav>
        <div className="p-4 border-t border-slate-800">
          <div className="flex items-center gap-3 mb-4">
            <div className="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center font-bold">{currentUser.nama[0]}</div>
            <div className="overflow-hidden">
              <p className="text-sm font-bold truncate">{currentUser.nama}</p>
              <p className="text-[10px] uppercase text-slate-400">{currentUser.role}</p>
            </div>
          </div>
          <button onClick={() => setScreen('auth')} className="flex items-center gap-2 text-red-400 text-sm hover:bg-red-500/10 w-full p-2 rounded-lg transition">
            <LogOut size={16} /> Keluar
          </button>
        </div>
      </aside>

      {/* Content */}
      <main className="flex-1 flex flex-col overflow-hidden">
        <header className="bg-white border-b p-4 flex justify-between items-center px-8">
          <h2 className="text-xl font-bold text-slate-700 capitalize">{page}</h2>
          <div className="bg-green-100 text-green-700 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest flex items-center gap-2">
            <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Online
          </div>
        </header>

        <div className="flex-1 overflow-y-auto p-8">
          {page === 'dashboard' && <DashboardView inventory={inventory} user={currentUser} />}
          {page === 'barang' && (
            <div className="space-y-6">
              <div className="flex justify-between items-center">
                <h3 className="text-lg font-bold">Data Barang Koperasi</h3>
                <button onClick={() => { setFormData({id:'', nama:'', kategori:'', harga:'', stok:''}); setModalOpen(true); }} className="bg-slate-900 text-white px-4 py-2 rounded-xl flex items-center gap-2">
                  <Plus size={18} /> Tambah Barang
                </button>
              </div>
              <div className="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <table className="w-full text-left">
                  <thead className="bg-slate-50 text-slate-400 text-xs uppercase font-bold">
                    <tr>
                      <th className="p-4">Produk</th>
                      <th className="p-4">Kategori</th>
                      <th className="p-4 text-right">Harga</th>
                      <th className="p-4 text-center">Stok</th>
                      <th className="p-4 text-center">Aksi</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y">
                    {inventory.map(i => (
                      <tr key={i.id} className="hover:bg-slate-50">
                        <td className="p-4 font-bold">{i.nama}</td>
                        <td className="p-4"><span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">{i.kategori}</span></td>
                        <td className="p-4 text-right font-mono">Rp {Number(i.harga).toLocaleString()}</td>
                        <td className="p-4 text-center font-bold text-orange-600">{i.stok}</td>
                        <td className="p-4 text-center">
                          <button onClick={() => { setFormData(i); setModalOpen(true); }} className="text-slate-400 hover:text-slate-900"><Edit3 size={16}/></button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
          {page === 'penjualan' && (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              <div className="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 h-fit">
                {inventory.map(i => (
                  <div key={i.id} onClick={() => addToCart(i)} className="bg-white p-4 rounded-2xl border hover:border-orange-500 cursor-pointer transition group shadow-sm">
                    <div className="flex justify-between items-start">
                      <div>
                        <span className="text-[10px] uppercase font-bold text-slate-400">{i.kategori}</span>
                        <h4 className="font-bold text-slate-800 group-hover:text-orange-600 transition">{i.nama}</h4>
                        <p className="text-sm font-black text-slate-500 mt-1">Rp {Number(i.harga).toLocaleString()}</p>
                      </div>
                      <div className="bg-slate-100 p-2 rounded-lg group-hover:bg-orange-500 group-hover:text-white"><Plus size={16}/></div>
                    </div>
                  </div>
                ))}
              </div>
              <div className="bg-white p-6 rounded-3xl shadow-xl h-fit border border-slate-100">
                <h3 className="font-bold flex items-center gap-2 mb-4"><ShoppingBasket className="text-orange-500"/> Keranjang Belanja</h3>
                <div className="space-y-2 mb-6 max-h-[300px] overflow-y-auto">
                  {cart.length === 0 ? <p className="text-center text-slate-300 italic text-sm py-4">Belum ada barang</p> : 
                    cart.map(c => (
                      <div key={c.id} className="flex justify-between bg-slate-50 p-3 rounded-xl">
                        <div><p className="font-bold text-xs">{c.nama}</p><p className="text-[10px] text-slate-400">{c.qty} x Rp {c.harga.toLocaleString()}</p></div>
                        <b className="text-xs">Rp {(c.harga*c.qty).toLocaleString()}</b>
                      </div>
                    ))
                  }
                </div>
                <div className="border-t pt-4">
                  <div className="flex justify-between items-end mb-4">
                    <span className="text-slate-400 text-sm">Total</span>
                    <span className="text-2xl font-black">Rp {cart.reduce((a,b) => a+(b.harga*b.qty),0).toLocaleString()}</span>
                  </div>
                  <button onClick={processOrder} className="w-full bg-green-600 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-green-700 transition shadow-lg shadow-green-100">
                    <Send size={18}/> Kirim ke WhatsApp
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      </main>

      {/* Modal Barang */}
      {modalOpen && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <div className="bg-white p-8 rounded-3xl max-w-md w-full shadow-2xl">
            <h3 className="text-xl font-bold mb-6">Formulir Barang</h3>
            <form onSubmit={saveBarang} className="space-y-4">
              <input type="text" placeholder="Nama Barang" value={formData.nama} onChange={e=>setFormData({...formData, nama: e.target.value})} className="w-full p-4 bg-slate-50 border rounded-2xl" required />
              <input type="text" placeholder="Kategori (Misal: Sembako)" value={formData.kategori} onChange={e=>setFormData({...formData, kategori: e.target.value})} className="w-full p-4 bg-slate-50 border rounded-2xl" required />
              <div className="grid grid-cols-2 gap-4">
                <input type="number" placeholder="Harga" value={formData.harga} onChange={e=>setFormData({...formData, harga: e.target.value})} className="w-full p-4 bg-slate-50 border rounded-2xl" required />
                <input type="number" placeholder="Stok" value={formData.stok} onChange={e=>setFormData({...formData, stok: e.target.value})} className="w-full p-4 bg-slate-50 border rounded-2xl" required />
              </div>
              <div className="flex gap-2 pt-4">
                <button type="button" onClick={()=>setModalOpen(false)} className="flex-1 py-4 text-slate-400 font-bold">Batal</button>
                <button type="submit" className="flex-[2] bg-slate-900 text-white py-4 rounded-2xl font-bold">Simpan Data</button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

function NavItem({ active, onClick, icon, label }) {
  return (
    <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition ${active ? 'bg-slate-800 text-orange-500 font-bold border-l-4 border-orange-500' : 'text-slate-400 hover:bg-slate-800'}`}>
      {icon} {label}
    </button>
  );
}

function LoadingOverlay({ text }) {
  return (
    <div className="fixed inset-0 bg-white/80 z-[9999] flex flex-col items-center justify-center">
      <div className="w-12 h-12 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mb-4"></div>
      <p className="font-bold text-slate-600">{text}</p>
    </div>
  );
}

function DashboardView({ inventory, user }) {
  const totalBarang = inventory.length;
  const totalStok = inventory.reduce((a, b) => a + Number(b.stok), 0);
  const totalAset = inventory.reduce((a, b) => a + (Number(b.harga) * Number(b.stok)), 0);

  return (
    <div className="space-y-8">
      <div className="bg-slate-900 text-white p-8 rounded-3xl relative overflow-hidden">
        <div className="relative z-10">
          <h1 className="text-3xl font-bold">Selamat Datang, {user.nama}! ðŸ‘‹</h1>
          <p className="text-slate-400 mt-2 max-w-sm">Siap melayani kebutuhan anggota koperasi hari ini? Akses menu di samping untuk mulai bekerja.</p>
        </div>
        <Store size={200} className="absolute right-[-40px] bottom-[-40px] text-white/5" />
      </div>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <StatCard title="Total Produk" value={totalBarang} color="slate" />
        <StatCard title="Total Stok" value={totalStok} color="blue" />
        <StatCard title="Nilai Aset" value={`Rp ${totalAset.toLocaleString()}`} color="green" />
      </div>
    </div>
  );
}

function StatCard({ title, value, color }) {
  const colors = {
    slate: 'text-slate-800',
    blue: 'text-blue-600',
    green: 'text-green-600'
  };
  return (
    <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
      <p className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-1">{title}</p>
      <h3 className={`text-3xl font-black ${colors[color]}`}>{value}</h3>
    </div>
  );
}
